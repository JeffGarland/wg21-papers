\newcommand\wgTitle{Merge data-parallel types from the Parallelism TS 2}
\newcommand\wgName{Matthias Kretz <m.kretz@gsi.de>}
\newcommand\wgDocumentNumber{D1928R1}
\newcommand\wgGroup{SG1}
\newcommand\wgTarget{\CC{}23}
%\newcommand\wgAcknowledgements{ }

\usepackage{mymacros}
\usepackage{wg21}
\setcounter{tocdepth}{2} % show sections and subsections in TOC
\hypersetup{bookmarksdepth=5}
\usepackage{changelog}
\usepackage{underscore}

\addbibresource{extra.bib}

\newcommand\simd[1][]{\type{simd#1}\xspace}
\newcommand\simdT{\type{simd<T>}\xspace}
\newcommand\valuetype{\type{value\_type}\xspace}
\newcommand\referencetype{\type{reference}\xspace}
\newcommand\whereexpression{\type{where\_expression}\xspace}
\newcommand\simdcast{\code{simd\_cast}\xspace}
\newcommand\mask[1][]{\type{simd\_mask#1}\xspace}
\newcommand\maskT{\type{simd\_mask<T>}\xspace}
\newcommand\fixedsizeN{\type{simd\_abi::fixed\_size<N>}\xspace}
\newcommand\fixedsizescoped{\type{simd\_abi::fixed\_size}\xspace}
\newcommand\fixedsize{\type{fixed\_size}\xspace}
\newcommand\wglink[1]{\href{https://wg21.link/#1}{#1}}

\begin{document}
\selectlanguage{american}
\begin{wgTitlepage}
  After the Parallelism TS 2 was published in 2018, data-parallel types (\simdT) have been implemented and used, and we are receiving feedback, this paper proposes to merge Section 9 of the Parallelism TS 2 into the IS working draft.
\end{wgTitlepage}

\pagestyle{scrheadings}

\input{changelog}
%\input{strawpolls}

\section{Introduction}
\cite{P0214R9} introduced \simdT and related types and functions into the Parallelism TS 2 Section 9.
The TS was published in 2018.
An incomplete and non-conforming (because P0214 evolved) implementation existed for the whole time P0214 progressed through the committee.
Shortly after the GCC 9 release, a complete implementation of Section 9 of the TS was made available.
Since GCC 11 a complete \code{simd} implementation of the TS is part of its standard library.

Note: The first revision of this paper did not proposing a merge.
In the meantime the TS feedback progressed to a point where a merge should happen ASAP.

\subsection{Related papers}
\begin{description}
  \item[\wglink{P0350}] Before publication of the TS, SG1 approved \cite{P0350R0} which did not progress in time in LEWG to make it into the TS.
    \wglink{P0350} is moving forward independently.

  \item[\wglink{P0918}] After publication of the TS, SG1 approved \cite{P0918R2} which adds \code{shuffle}, \code{interleave}, \code{sum_to}, \code{multiply_sum_to}, and \code{saturated_simd_cast}.
    \wglink{P0918} will move forward independently.

  \item[\wglink{P1068}] R3 of the paper removed discussion/proposal of a \code{simd} based API because it was targeting \CC{}23 with the understanding of \code{simd} not being ready for \CC{}23.
    This is unfortunate as the presence of \code{simd} in the IS might lead to a considerably different assessment of the iterator/range-based API proposed in P1068.

  \item[\wglink{P0917}] The ability to write code that is generic wrt. arithmetic types and \code{simd} types is considered to be of high value (TS feedback).
    Conditional expressions via the \code{where} function were not all too well received.
    Conditional expressions via the conditional operator would provide a solution deemed perfect by those giving feedback (myself included).

  \item[draft on non-member {operator[]}] TODO

  \item[\wglink{P2600}] The fix for ADL is important to ensure the above two papers do not break existing code.

  \item[\wglink{P0543}] The paper proposing functions for saturation arithmetic expects \code{simd} overloads as soon as \code{simd} is merged to the IS.

  \item[\wglink{P0553}] The bit operations that are part of \CC{}20 expects \code{simd} overloads as soon as \code{simd} is merged to the IS.

\end{description}
The papers \wglink{P0350}, \wglink{P0918}, and the \code{simd}-based \wglink{P1068} fork currently have no shipping vehicle and are basically blocked on this paper.

\section{Changes after TS feedback}
This section is mostly a stub.
\cite{P1915R0} (Expected Feedback from \code{simd} in the Parallelism TS 2) was just published and asks for specific feedback.
After gathering feedback, the relevant changes will be added to a new revision of this paper.

\subsection{Missing \code{simd_mask} generator constructor}
The \code{simd} generator constructor is very useful for initializing objects from scalars in a portable (different \code{size()}) fashion.
The need for a similar constructor for \code{simd_mask} is less frequent, but if only for consistency, there should be one.
Besides consistency, it is also useful, of course.
Consider a predicate function that is given without \code{simd} interface (e.g. from a library).
How do you construct a \code{simd_mask} from it?
With a generator constructor it is easy:
\medskip\begin{lstlisting}[style=Vc]
simd<T> f(simd<T> x, Predicate p) {
  const simd_mask<T> k([&](auto i) { return p(x[i]); });
  where(k, x) = 0;
  return x;
}
\end{lstlisting}
Without the generator constructor one has to write e.g.:
\medskip\begin{lstlisting}[style=Vc]
simd<T> f(simd<T> x, Predicate p) {
  simd_mask<T> k;
  for (size_t i = 0; i < simd<T>::size(); ++i) {
    k[i] = p(x[i]);
  }
  where(k, x) = 0;
  return x;
}
\end{lstlisting}
The latter solution makes it hard to initialize the \code{simd_mask} as \code{const}, is more verbose, is harder to optimize, and cannot use the sequencing properties the generator constructor allows.

Therefore add:
\begin{wgText}
\begin{itemdecl}
template<class G> simd_mask(G&& gen) noexcept;
\end{itemdecl}
\end{wgText}

\subsection{Add missing casts for \code{simd_mask}}
The \code{simd_cast} and \code{static_simd_cast} overloads for \code{simd_mask} were forgotten for the TS.
Without those casts (and no casts via constructors) mixing different arithmetic types is painful.
There is no motivation for forbidding casts on \code{simd_mask}.

Therefore add the following overloads:
\begin{wgText}
\begin{codeblock}
  template<class T, class U, class Abi> @\seebelow@ simd_cast(const simd_mask<U, Abi>&) noexcept;
  template<class T, class U, class Abi> @\seebelow@ static_simd_cast(const simd_mask<U, Abi>&) noexcept;
\end{codeblock}
\end{wgText}

\subsection{\code{element_reference} is overspecified}
\code{element_reference} is spelled out in a lot of detail.
It may be better to define its requirements in a table instead.

This change is not reflected in the wording, pending encouragement from WG21 (mostly LWG).

\subsection{Clean up math function overloads}
The wording that produces \code{simd} overloads misses a few cases and leaves room for ambiguity.
There is also no explicit mention of integral overloads that are supported in \code{<cmath>} (e.g. \code{std::cos(1)} calling \code{std::cos(double)}).

This needs more work and is not reflected in the wording at this point.


\section{Open questions}

\subsection{Integration with ranges}
\code{simd} itself is not a range.
The value of a data-parallel object is not an array of elements but rather needs to be understood as a single opaque value that happens to have means for reading and writing element values.
I.e. \code{simd<int> x = \{\};} does not start the lifetime of \type{int} objects.
The \code{element_reference} for \code{operator[]} is bad enough as is.
Let's not exacerbate the problem by adding iterators to \code{simd}.

Instead, a \code{simd} can be converted into an array (e.g. \lst{simdtoarray}).
Conversely, a \std\code{span} with static extent can be converted into a \std\type{simd}.
\begin{lstlisting}[numbers=left,float={hbtp},label=lst:simdtoarray,caption={
  \code{simd} to \code{array} conversion
}]
template <class T, class A>
std::array<T, std::simd_size_v<T, A>> to_array(std::simd<T, A> x)
{
  std::array<T, std::simd_size_v<T, A>> r;
  x.copy_to(r.data());
  return r;
}
\end{lstlisting}

I plan to pursue conversions to array and from span with static extent in a follow-up paper.
I believe it is not necessary to resolve this question before merging \code{simd} from the TS.

\subsection{Correct place for \code{simd} in the IS?}

While \code{simd} is certainly very important for numerics and therefore fits into the “Numerics library” clause, it is also more than that.
E.g. \code{simd} can be used for vectorization of text processing.
In principle \code{simd} should be understood similar to fundamental types.
Is the “General utilities library” clause a better place?
Or rename “Concurrency support library” to “Parallelism and concurrency support library” and put it there?
Alternatively, add a new library clause?

\section{Wording}

The following section presents the wording to be applied against the \CC{} working draft.
The subsequent \sect{diff} reproduces the same wording as a diff against the Parallelism TS 2.

\subsection{Add Section 9 of N4808 with modifications}\label{sec:wording}

\begin{wgText}[Add a new subclause after §28.8 {[numbers]}]
  \def\wgRem#1{}
  \def\wgAdd#1{#1}
  \def\wgChange#1#2{#2}
  \colorlet{WgAdd}{black}
  \colorlet{WgRem}{white}
  \setcounter{WGClause}{28}
  \setcounter{WGSubSection}{8}
  \lstset{%
    columns=fullflexible,
    deletedelim=**[is]{|-}{-|},
    moredelim=[is][\color{white}\fontsize{0.1pt}{0.1pt}\selectfont{}]{|-}{-|}
  }
  \input{wording}
\end{wgText}

\subsection{Diff against Parallelism TS 2 (N4808)}\label{sec:diff}

In the following, the wording from \sect{wording} is repeated with additional indications of differences with regard to N4808.
Changes relative to N4808, which contains editorial changes after the publication of the TS, are marked using color for \textcolor{WgAdd}{additions} and \textcolor{WgRem}{removals}.

\def\wgLabelPrefix{diff}%
\begin{wgText}
  \setcounter{WGClause}{28}
  \setcounter{WGSubSection}{8}
  \input{wording}
\end{wgText}

\end{document}
% vim: sw=2 sts=2 ai et tw=0
